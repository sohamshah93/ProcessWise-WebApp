<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Uploader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<header class="container">
  <div class="d-flex justify-content-between align-items-center my-3">
    <h1>ProcessWise</h1>
  </div>
</header>
<main class="container mt-5">
  <h1 class="text-center mb-4">Document Uploader</h1>
  <div class="row justify-content-center">
    <div class="col-md-6">
      <form id="uploadForm">
        <select id="templateSelect" class="form-select mb-3" required>
          <option value="" disabled selected>Select a template</option>
        </select>
        <div class="input-group mb-3">
          <input type="file" class="form-control" id="fileInput" accept=".txt,.pdf,.docx,.xlsx" required>
          <button class="btn btn-primary" type="submit">Upload</button>
        </div>
      </form>
      <div id="alertBox" class="alert d-none" role="alert"></div>
      <div id="statusBox" class="d-none">
        <strong id="statusText"></strong>
      </div>
    </div>
  </div>
</main>

<script>
  function getTemplates() {
    $.ajax({
      url: '/get_templates',
      type: 'GET',
      success: function (response) {
        var templates = response.templates;
        for (var i = 0; i < templates.length; i++) {
          var template = templates[i];
          var option = $('<option>').val(template.id).text(template.name);
          $('#templateSelect').append(option);
        }
      },
      error: function (response) {
        showAlert(response.responseJSON.message, 'danger');
      },
    });
  }

  function showAlert(message, alertType) {
    $("#alertBox").html(message).addClass(`alert-${alertType}`).removeClass("d-none");
    setTimeout(function () {
      $("#alertBox").addClass("d-none").removeClass(`alert-${alertType}`);
    }, 3000);
  }

  function updateStatus(statusText, showStatus) {
    if (showStatus) {
      $("#statusText").text(statusText);
      $("#statusBox").removeClass("d-none");
    } else {
      $("#statusBox").addClass("d-none");
    }
  }

  $(document).ready(function () {
    getTemplates();

    $("#uploadForm").on("submit", function (e) {
      e.preventDefault();
      var fileInput = document.getElementById("fileInput");
      if (fileInput.files.length === 0) {
        showAlert("Please select a file to upload.", "danger");
        return;
      }
      var formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("template_id", $('#templateSelect').val());
      $.ajax({
        url: "/upload",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        xhrFields: {
          onprogress: function (e) {
            if (e.lengthComputable) {
              updateStatus("Processing: " + (e.loaded / e.total * 100) + "%", true);
            }
          },
        },
        beforeSend: function () {
          updateStatus("Uploading file...", true);
        },
        success: function (response) {
          showAlert("File processed successfully", "success");
          updateStatus("", false);
        },
        error: function (response) {
          showAlert("Error processing the file", "danger");
          updateStatus("", false);
        },
      });
    });
  });
</script>
<footer class="container mt-5">
  <p class="text-center">&copy; ProcessWise 2023. All rights reserved.</p>
</footer>
</body>
</html>