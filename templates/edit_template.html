<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Template</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h1>Edit Template</h1>
  <form id="editTemplateForm">
    <input type="hidden" id="templateId" value="{{ template_id }}">
    <div class="mb-3">
      <label for="templateName" class="form-label">Template Name</label>
      <input type="text" class="form-control" id="templateName" value="{{ template_name }}" required>
    </div>
    <div class="mb-3">
      <label for="documentType" class="form-label">Document Type</label>
      <select class="form-select" id="documentType" required>
        <option value="">Choose...</option>
        <option value="Invoice" {% if template_document_type == "Invoice" %}selected{% endif %}>Invoice</option>
        <option value="Purchase Order" {% if template_document_type == "Purchase Order" %}selected{% endif %}>Purchase Order</option>
        <option value="Receipt" {% if template_document_type == "Receipt" %}selected{% endif %}>Receipt</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Prompt Fields</label>
    </div>
    <div class="mb-3" id="fieldsContainer">
      <!-- Added fields will be displayed here -->
    </div>
    <button type="button" id="addField" class="btn btn-secondary mb-3">Add Field</button>
    <button type="submit" class="btn btn-primary">Update Template</button>
  </form>
</div>
<script>
    let fieldCount = 1;

    function initFields() {
        {% for field in template_prompts %}
        addField('{{ field.field }}', '{{ field.category }}');
        {% endfor %}
    }

    function addField(value, category) {
        const newField = $(`<div class="row mt-2">
                                <div class="col-5">
                                  <input type="text" class="form-control prompt-field" value="${value}" placeholder="Field ${fieldCount}">
                                </div>
                                <div class="col-5">
                                  <select class="form-select field-category" required>
                                    <option value="">Select category...</option>
                                    <option value="Column Fields" ${category === "Column Fields" ? "selected" : ""}>Column Fields</option>
                                    <option value="Simple Fields" ${category === "Simple Fields" ? "selected" : ""}>Simple Fields</option>
                                    <option value="Other" ${category === "Other" ? "selected" : ""}>Other</option>
                                  </select>
                                </div>
                                <div class="col-1">
                                  <button type="button" class="btn btn-danger delete-field" onclick="deleteField(this)">Delete</button>
                                </div>
                              </div>`);

        $("#fieldsContainer").append(newField);
        fieldCount++;
    }

    function deleteField(button) {
        var fieldRow = button.closest(".row");
        fieldRow.remove();
    }

    initFields();

    $("#addField").on("click", function() {
        addField('', '');
    });

    $("#editTemplateForm").on("submit", function(e) {
        e.preventDefault();

        var templateId = $("#templateId").val();
        var templateName = $("#templateName").val();
        var documentType = $("#documentType").val();
        var prompts = [];

        $(".row").each(function() {
            var field = $(this).find(".prompt-field").val();
            var category = $(this).find(".field-category").val();
            if (field && category) {
                prompts.push({ field: field, category: category });
            }
        });

        $.ajax({
            url: "/update_template/" + templateId,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({
                template_name: templateName,
                document_type: documentType,
                prompt: prompts
            }),
            success: function(response) {
                alert("Template updated successfully!");
                window.location.href = "/modify_templates";
            },
            error: function(error) {
                console.log("Error: ", error);
                alert("An error occurred while updating the template.");
            }
        });
    });
</script>
</body>
</html>